
R version 4.5.2 (2025-10-31 ucrt) -- "[Not] Part in a Rumble"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: x86_64-w64-mingw32/x64

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

[Workspace loaded from ~/.RData]

> # 加载必要的R包
> library(quantmod) # 金融数据获取与分析
Loading required package: xts
Loading required package: zoo

Attaching package: ‘zoo’

The following objects are masked from ‘package:base’:

    as.Date, as.Date.numeric

Loading required package: TTR
Registered S3 method overwritten by 'quantmod':
  method            from
  as.zoo.data.frame zoo 
> library(PerformanceAnalytics) # 投资组合绩效分析

Attaching package: ‘PerformanceAnalytics’

The following object is masked _by_ ‘.GlobalEnv’:

    prices

The following object is masked from ‘package:graphics’:

    legend
> library(ggplot2) # 高级绘图
> library(dplyr) # 数据处理

######################### Warning from 'xts' package ##########################
#                                                                             #
# The dplyr lag() function breaks how base R's lag() function is supposed to  #
# work, which breaks lag(my_xts). Calls to lag(my_xts) that you type or       #
# source() into this session won't work correctly.                            #
#                                                                             #
# Use stats::lag() to make sure you're not using dplyr::lag(), or you can add #
# conflictRules('dplyr', exclude = 'lag') to your .Rprofile to stop           #
# dplyr from breaking base R's lag() function.                                #
#                                                                             #
# Code in packages is not affected. It's protected by R's namespace mechanism #
# Set `options(xts.warn_dplyr_breaks_lag = FALSE)` to suppress this warning.  #
#                                                                             #
###############################################################################

Attaching package: ‘dplyr’

The following objects are masked from ‘package:xts’:

    first, last

The following objects are masked from ‘package:stats’:

    filter, lag

The following objects are masked from ‘package:base’:

    intersect, setdiff, setequal, union
> library(tidyr) # 数据整理
> library(scales) # 图形标度调整
> library(patchwork) # 图形组合
> library(cowplot) # 图形组合（更精细的控制）

Attaching package: ‘cowplot’

The following object is masked from ‘package:patchwork’:

    align_plots
> 
> # 1. 数据获取与预处理
> # 设置回测时间段 - 确保使用正确的日期格式
> backtest_start <- "2024-01-01"
> #backtest_end <- Sys.Date()
> backtest_end <- "2026-01-27"
> 
> # 转换为日期类型
> start_date <- as.Date(backtest_start)
> end_date <- as.Date(backtest_end)
> 
> # 定义ETF代码 (基于常识的常见代码，Yahoo Finance格式)
> # 沪市纳指ETF: 513100.SS
> # 沪深300ETF: 510300.SS
> # 黄金ETF: 518880.SS
> etf_symbols <- c("513100.SS", "510300.SS", "518880.SS")
> etf_names <- c("纳指ETF", "沪深300ETF", "黄金ETF")
> origin_data_dir <- "origin_data"
> if (!dir.exists(origin_data_dir)) {
+   dir.create(origin_data_dir, recursive = TRUE)
+   cat("已创建文件夹:", origin_data_dir, "\n")
+ }
已创建文件夹: origin_data 
> Sys.setenv(http_proxy  = "http://127.0.0.1:1080/")
> Sys.setenv(https_proxy = "http://127.0.0.1:1080/")
> # 从Yahoo Finance获取数据或从本地缓存加载
> # 函数: 加载或下载单个ETF数据
> load_or_download_etf <- function(symbol, from_date, to_date, cache_dir) {
+   # 生成缓存文件名
+   cache_file <- file.path(cache_dir, paste0(gsub("\\.", "_", symbol), ".rds"))
+   
+   # 检查缓存文件是否存在
+   if (file.exists(cache_file)) {
+     cat("从缓存文件加载:", symbol, "\n")
+     etf_data <- readRDS(cache_file)
+     
+     # 验证数据完整性和日期范围
+     data_start <- start(etf_data)
+     data_end <- end(etf_data)
+     
+     # 如果缓存数据涵盖所需日期范围，直接使用
+     if (data_start <= from_date && data_end >= to_date) {
+       cat("  缓存数据有效，日期范围: ", as.character(data_start), " 至 ", as.character(data_end), "\n")
+       return(etf_data)
+     } else {
+       cat("  缓存数据日期范围不足，重新下载\n")
+     }
+   }
+   
+   # 从Yahoo Finance下载数据
+   cat("从Yahoo Finance下载:", symbol, "\n")
+   tryCatch(
+     {
+       etf_data <- getSymbols(symbol,
+                              from = from_date,
+                              to = to_date,
+                              src = "yahoo",
+                              auto.assign = FALSE
+       )
+       
+       # 保存到缓存文件
+       saveRDS(etf_data, cache_file)
+       cat("  数据已保存到缓存文件:", cache_file, "\n")
+       
+       return(etf_data)
+     },
+     error = function(e) {
+       cat("  下载失败:", conditionMessage(e), "\n")
+       return(NULL)
+     }
+   )
+ }
> 
> # 批量加载或下载所有ETF数据
> cat("正在加载ETF数据...\n")
正在加载ETF数据...
> for (symbol in etf_symbols) {
+   etf_data <- load_or_download_etf(symbol, start_date, end_date, origin_data_dir)
+   if (!is.null(etf_data)) {
+     assign(symbol, etf_data, envir = .GlobalEnv)
+   } else {
+     stop("无法获取数据:", symbol)
+   }
+ }
从Yahoo Finance下载: 513100.SS 
  数据已保存到缓存文件: origin_data/513100_SS.rds 
从Yahoo Finance下载: 510300.SS 
  数据已保存到缓存文件: origin_data/510300_SS.rds 
从Yahoo Finance下载: 518880.SS 
  数据已保存到缓存文件: origin_data/518880_SS.rds 
Warning messages:
1: 510300.SS contains missing values. Some functions will not work if objects contain missing values in the middle of the series. Consider using na.omit(), na.approx(), na.fill(), etc to remove or replace them. 
2: 518880.SS contains missing values. Some functions will not work if objects contain missing values in the middle of the series. Consider using na.omit(), na.approx(), na.fill(), etc to remove or replace them. 
> cat("所有ETF数据加载完成\n\n")
所有ETF数据加载完成

> prices <- list()
> for (i in 1:length(etf_symbols)) {
+   symbol_data <- get(etf_symbols[i])
+   # 使用调整后收盘价
+   prices[[i]] <- Ad(symbol_data)
+ }
> names(prices) <- etf_names
> # 合并所有价格数据
> price_df <- do.call(merge, prices)
> colnames(price_df) <- etf_names
> 
> # 2. 计算指标：动量、波动率、调整动量
> calculate_metrics <- function(price_series, window = 20) {
+   # 计算日收益率
+   returns <- dailyReturn(price_series, type = "arithmetic")
+   colnames(returns) <- "Return"
+   
+   # 计算20日平均收益率（动量）
+   momentum <- rollapply(returns, width = window, FUN = mean, align = "right", fill = NA)
+   colnames(momentum) <- "Momentum"
+   
+   # 计算20日收益率方差（波动率）
+   volatility <- rollapply(returns, width = window, FUN = var, align = "right", fill = NA)
+   colnames(volatility) <- "Volatility"
+   
+   # 计算调整动量（动量/波动率）
+   # 注意：使用标准差进行标准化（方差的平方根）
+   adj_momentum <- momentum / sqrt(volatility)
+   colnames(adj_momentum) <- "Adj_Momentum"
+   
+   return(list(
+     returns = returns,
+     momentum = momentum,
+     volatility = volatility,
+     adj_momentum = adj_momentum
+   ))
+ }
> 
> # 为每个ETF计算指标
> cat("正在计算动量指标...\n")
正在计算动量指标...
> metrics_list <- list()
> for (etf in etf_names) {
+   metrics_list[[etf]] <- calculate_metrics(price_df[, etf])
+ }
Warning messages:
1: In to_period(xx, period = on.opts[[period]], ...) :
  missing values removed from data
2: In to_period(xx, period = on.opts[[period]], ...) :
  missing values removed from data
> 
> # 3. 生成交易信号和权重
> generate_weights <- function(adj_momentum_df) {
+   # 初始化权重数据框
+   weights_df <- as.data.frame(adj_momentum_df)
+   weights_df[] <- 0 # 所有值初始化为0
+   
+   # 对每一行（每个交易日）计算权重
+   for (i in 1:nrow(adj_momentum_df)) {
+     # 获取当日的调整动量值
+     current_momentum <- as.numeric(adj_momentum_df[i, ])
+     
+     # 筛选调整动量大于0的标的
+     positive_idx <- which(current_momentum > 0 & !is.na(current_momentum))
+     
+     if (length(positive_idx) > 0) {
+       # 获取正的调整动量值
+       positive_momentum <- current_momentum[positive_idx]
+       
+       # 按调整动量大小归一化计算权重
+       normalized_weights <- positive_momentum / sum(positive_momentum)
+       
+       # 分配权重
+       weights_df[i, positive_idx] <- normalized_weights
+     }
+   }
+   
+   # 转换为时间序列
+   weights_xts <- xts(weights_df, order.by = index(adj_momentum_df))
+   colnames(weights_xts) <- colnames(adj_momentum_df)
+   
+   return(weights_xts)
+ }
> 
> # 提取所有ETF的调整动量
> adj_momentum_all <- do.call(merge, lapply(metrics_list, function(x) x$adj_momentum))
> colnames(adj_momentum_all) <- etf_names
> 
> # 生成权重序列
> cat("正在计算每日权重...\n")
正在计算每日权重...
> weights <- generate_weights(adj_momentum_all)
> 
> # 4. 将权重数据整理到数据框中
> # 创建每日权重数据框（包含日期）
> daily_weights_df <- data.frame(Date = index(weights))
> for (etf in etf_names) {
+   daily_weights_df[[etf]] <- as.numeric(weights[, etf])
+ }
> 
> # 计算每个交易日的权重合计（应为1或0）
> daily_weights_df$权重合计 <- rowSums(daily_weights_df[, etf_names], na.rm = TRUE)
> 
> # 创建每个ETF的单独权重数据框
> etf_weight_dfs <- list()
> for (etf in etf_names) {
+   etf_weight_dfs[[etf]] <- data.frame(
+     Date = index(weights),
+     ETF = etf,
+     Weight = as.numeric(weights[, etf])
+   )
+ }
> 
> # 合并所有ETF权重数据框
> all_etf_weights_df <- do.call(rbind, etf_weight_dfs)
> 
> # 5. 回测计算
> # 计算每个ETF的日收益率
> returns_all <- do.call(merge, lapply(metrics_list, function(x) x$returns))
> colnames(returns_all) <- etf_names
> 
> # 调整权重的时间索引，确保与收益率对齐
> # 使用T日的权重在T+1日交易
> lagged_weights <- lag(weights, 1) # 权重滞后一天
> lagged_weights <- lagged_weights[index(returns_all)] # 对齐索引
> 
> # 处理缺失值
> lagged_weights[is.na(lagged_weights)] <- 0
> 
> # 计算策略日收益率（按T+1日开盘价计算，这里用平均价近似）
> strategy_returns <- rowSums(returns_all * lagged_weights, na.rm = TRUE)
> strategy_returns <- xts(strategy_returns, order.by = index(returns_all))
> colnames(strategy_returns) <- "动量策略"
> 
> # 6. 绩效指标计算
> cat("正在计算绩效指标...\n")
正在计算绩效指标...
> # 策略绩效
> strategy_perf <- table.AnnualizedReturns(strategy_returns)
> strategy_dd <- table.DownsideRisk(strategy_returns)
> max_dd <- maxDrawdown(strategy_returns)
> strategy_calmar <- CalmarRatio(strategy_returns)
> strategy_sortino <- SortinoRatio(strategy_returns)
> strategy_positive_returns <- sum(strategy_returns > 0, na.rm = TRUE)
> strategy_total_returns <- sum(!is.na(strategy_returns))
> strategy_win_rate <- strategy_positive_returns / strategy_total_returns
> 
> # 基准绩效（沪深300ETF）
> benchmark_returns <- returns_all[, "沪深300ETF"]
> colnames(benchmark_returns) <- "沪深300ETF"
> benchmark_perf <- table.AnnualizedReturns(benchmark_returns)
> benchmark_dd <- table.DownsideRisk(benchmark_returns)
> benchmark_max_dd <- maxDrawdown(benchmark_returns)
> benchmark_calmar <- CalmarRatio(benchmark_returns)
> benchmark_sortino <- SortinoRatio(benchmark_returns)
> benchmark_positive_returns <- sum(benchmark_returns > 0, na.rm = TRUE)
> benchmark_total_returns <- sum(!is.na(benchmark_returns))
> benchmark_win_rate <- benchmark_positive_returns / benchmark_total_returns
> 
> # 等权重组合绩效
> equal_weights <- matrix(1 / 3, nrow = nrow(returns_all), ncol = ncol(returns_all))
> equal_weights <- xts(equal_weights, order.by = index(returns_all))
> colnames(equal_weights) <- etf_names
> equal_returns <- rowSums(returns_all * equal_weights, na.rm = TRUE)
> equal_returns <- xts(equal_returns, order.by = index(returns_all))
> colnames(equal_returns) <- "等权重组合"
> equal_perf <- table.AnnualizedReturns(equal_returns)
> equal_max_dd <- maxDrawdown(equal_returns)
> equal_calmar <- CalmarRatio(equal_returns)
> equal_sortino <- SortinoRatio(equal_returns)
> equal_positive_returns <- sum(equal_returns > 0, na.rm = TRUE)
> equal_total_returns <- sum(!is.na(equal_returns))
> equal_win_rate <- equal_positive_returns / equal_total_returns
> 
> # 7. 创建绩效指标汇总数据框
> # 准备回测期间字符串
> backtest_period <- paste0(
+   format(as.Date(backtest_start), "%Y-%m-%d"),
+   " 至 ",
+   format(end_date, "%Y-%m-%d")
+ )
> 
> performance_metrics_df <- data.frame(
+   策略 = c("动量策略", "沪深300ETF", "等权重组合"),
+   年化收益率 = c(
+     round(strategy_perf[1, 1] * 100, 2),
+     round(benchmark_perf[1, 1] * 100, 2),
+     round(equal_perf[1, 1] * 100, 2)
+   ),
+   年化波动率 = c(
+     round(strategy_perf[2, 1] * 100, 2),
+     round(benchmark_perf[2, 1] * 100, 2),
+     round(equal_perf[2, 1] * 100, 2)
+   ),
+   夏普比率 = c(
+     round(strategy_perf[3, 1], 3),
+     round(benchmark_perf[3, 1], 3),
+     round(equal_perf[3, 1], 3)
+   ),
+   最大回撤 = c(
+     round(max_dd * 100, 2),
+     round(benchmark_max_dd * 100, 2),
+     round(equal_max_dd * 100, 2)
+   ),
+   卡尔马比率 = c(
+     round(strategy_calmar, 3),
+     round(benchmark_calmar, 3),
+     round(equal_calmar, 3)
+   ),
+   索提诺比率 = c(
+     round(strategy_sortino, 3),
+     round(benchmark_sortino, 3),
+     round(equal_sortino, 3)
+   ),
+   胜率 = c(
+     round(strategy_win_rate * 100, 2),
+     round(benchmark_win_rate * 100, 2),
+     round(equal_win_rate * 100, 2)
+   ),
+   正收益天数 = c(
+     strategy_positive_returns,
+     benchmark_positive_returns,
+     equal_positive_returns
+   ),
+   总交易天数 = c(
+     strategy_total_returns,
+     benchmark_total_returns,
+     equal_total_returns
+   ),
+   回测期间 = c(backtest_period, backtest_period, backtest_period)
+ )
> 
> # 8. 绩效指标输出
> cat("==================== 绩效指标汇总数据框 ====================\n\n")
==================== 绩效指标汇总数据框 ====================

> print(performance_metrics_df)
        策略 年化收益率 年化波动率 夏普比率 最大回撤 卡尔马比率 索提诺比率  胜率 正收益天数 总交易天数                 回测期间
1   动量策略      50.09      17.01    2.946     8.72      5.747      0.251 53.29        267        501 2024-01-01 至 2026-01-27
2 沪深300ETF      21.11      18.93    1.115    16.25      1.299      0.109 51.60        258        500 2024-01-01 至 2026-01-27
3 等权重组合      33.97      12.78    2.658     9.29      3.658      0.216 59.48        298        501 2024-01-01 至 2026-01-27
> cat("\n")

> 
> # 9. 输出权重数据
> cat("==================== 每日组合权重数据框 ====================\n\n")
==================== 每日组合权重数据框 ====================

> cat("每日组合权重数据框（前10行）:\n")
每日组合权重数据框（前10行）:
> print(head(daily_weights_df, 10))
         Date 纳指ETF 沪深300ETF 黄金ETF 权重合计
1  2024-01-02       0          0       0        0
2  2024-01-03       0          0       0        0
3  2024-01-04       0          0       0        0
4  2024-01-05       0          0       0        0
5  2024-01-08       0          0       0        0
6  2024-01-09       0          0       0        0
7  2024-01-10       0          0       0        0
8  2024-01-11       0          0       0        0
9  2024-01-12       0          0       0        0
10 2024-01-15       0          0       0        0
> cat("\n")

> 
> cat("每日组合权重数据框（后10行）:\n")
每日组合权重数据框（后10行）:
> print(tail(daily_weights_df, 10))
          Date    纳指ETF 沪深300ETF   黄金ETF 权重合计
492 2026-01-13 0.00000000  0.4951292 0.5048708        1
493 2026-01-14 0.04341420  0.4717608 0.4848250        1
494 2026-01-15 0.11744744  0.4751051 0.4074475        1
495 2026-01-16 0.03744561  0.4600617 0.5024926        1
496 2026-01-19 0.05013198  0.4621911 0.4876769        1
497 2026-01-20 0.00000000  0.4098014 0.5901986        1
498 2026-01-21 0.00000000  0.3491649 0.6508351        1
499 2026-01-22 0.00000000  0.3705332 0.6294668        1
500 2026-01-23 0.00000000  0.2265571 0.7734429        1
501 2026-01-26 0.00000000  0.1810968 0.8189032        1
> cat("\n")

> 
> cat("组合权重统计信息:\n")
组合权重统计信息:
> cat("总交易日数:", nrow(daily_weights_df), "\n")
总交易日数: 501 
> cat("有权重分配的交易日数:", sum(daily_weights_df$权重合计 > 0), "\n")
有权重分配的交易日数: 470 
> cat("无权重分配的交易日数:", sum(daily_weights_df$权重合计 == 0), "\n\n")
无权重分配的交易日数: 31 

> 
> # 计算每个ETF的权重统计
> cat("各ETF权重统计:\n")
各ETF权重统计:
> for (etf in etf_names) {
+   etf_weights <- daily_weights_df[[etf]]
+   cat(etf, ":\n")
+   cat("  平均权重:", round(mean(etf_weights) * 100, 2), "%\n")
+   cat("  最大权重:", round(max(etf_weights) * 100, 2), "%\n")
+   cat("  最小权重:", round(min(etf_weights) * 100, 2), "%\n")
+   cat("  正权重天数:", sum(etf_weights > 0), "\n")
+   cat("  零权重天数:", sum(etf_weights == 0), "\n\n")
+ }
纳指ETF :
  平均权重: 30.04 %
  最大权重: 100 %
  最小权重: 0 %
  正权重天数: 336 
  零权重天数: 165 

沪深300ETF :
  平均权重: 22.89 %
  最大权重: 100 %
  最小权重: 0 %
  正权重天数: 292 
  零权重天数: 209 

黄金ETF :
  平均权重: 40.88 %
  最大权重: 100 %
  最小权重: 0 %
  正权重天数: 369 
  零权重天数: 132 

> 
> # 10. 输出每个ETF的权重数据框
> cat("==================== 每个ETF的权重数据框 ====================\n\n")
==================== 每个ETF的权重数据框 ====================

> for (etf in etf_names) {
+   cat(etf, "权重数据框（前5行）:\n")
+   etf_df <- etf_weight_dfs[[etf]]
+   print(head(etf_df, 5))
+   cat("\n")
+ }
纳指ETF 权重数据框（前5行）:
        Date     ETF Weight
1 2024-01-02 纳指ETF      0
2 2024-01-03 纳指ETF      0
3 2024-01-04 纳指ETF      0
4 2024-01-05 纳指ETF      0
5 2024-01-08 纳指ETF      0

沪深300ETF 权重数据框（前5行）:
        Date        ETF Weight
1 2024-01-02 沪深300ETF      0
2 2024-01-03 沪深300ETF      0
3 2024-01-04 沪深300ETF      0
4 2024-01-05 沪深300ETF      0
5 2024-01-08 沪深300ETF      0

黄金ETF 权重数据框（前5行）:
        Date     ETF Weight
1 2024-01-02 黄金ETF      0
2 2024-01-03 黄金ETF      0
3 2024-01-04 黄金ETF      0
4 2024-01-05 黄金ETF      0
5 2024-01-08 黄金ETF      0

> 
> # 11. 绘制图表
> cat("正在生成图表...\n")
正在生成图表...
> 
> # 准备累计收益率数据
> cumulative_returns <- merge(
+   cumprod(1 + na.fill(strategy_returns, 0)) - 1,
+   cumprod(1 + na.fill(benchmark_returns, 0)) - 1,
+   cumprod(1 + na.fill(equal_returns, 0)) - 1
+ )
> colnames(cumulative_returns) <- c("动量策略", "沪深300ETF", "等权重组合")
> 
> # 转换为数据框用于ggplot
> cumulative_df <- data.frame(
+   Date = index(cumulative_returns),
+   as.data.frame(cumulative_returns)
+ )
> 
> # 计算最大回撤数据
> calculate_drawdown <- function(returns) {
+   cum_returns <- cumprod(1 + na.fill(returns, 0))
+   drawdown <- cum_returns / cummax(cum_returns) - 1
+   return(drawdown)
+ }
> 
> # 计算各策略的回撤
> drawdowns <- merge(
+   calculate_drawdown(strategy_returns),
+   calculate_drawdown(benchmark_returns),
+   calculate_drawdown(equal_returns)
+ )
> colnames(drawdowns) <- c("动量策略", "沪深300ETF", "等权重组合")
> 
> # 转换为数据框用于ggplot
> drawdown_df <- data.frame(
+   Date = index(drawdowns),
+   as.data.frame(drawdowns)
+ )
> 
> # 定义颜色方案
> colors_strategies <- c(
+   "动量策略" = "#E41A1C", # 红色
+   "沪深300ETF" = "#377EB8", # 蓝色
+   "等权重组合" = "#4DAF4A" # 绿色
+ )
> 
> # 设置面积图的透明度
> area_alpha <- 0.3
> 
> # ============================================================
> # 图表1: 动量策略 vs 沪深300ETF 组合图
> # ============================================================
> # 筛选数据
> vs_benchmark_cumulative <- cumulative_df %>%
+   select(Date, 动量策略, 沪深300ETF) %>%
+   pivot_longer(cols = -Date, names_to = "策略", values_to = "累计收益率")
> 
> vs_benchmark_drawdown <- drawdown_df %>%
+   select(Date, 动量策略, 沪深300ETF) %>%
+   pivot_longer(cols = -Date, names_to = "策略", values_to = "回撤")
> 
> # 累计收益率图（隐藏X轴，图例放在左上角，上下排列）
> p1_cumulative <- ggplot(
+   vs_benchmark_cumulative,
+   aes(x = Date, y = 累计收益率, color = 策略)
+ ) +
+   geom_line(size = 1.2) +
+   labs(
+     title = "动量策略 vs 沪深300ETF: 累计收益率",
+     x = "", y = "累计收益率"
+   ) +
+   scale_y_continuous(labels = percent_format()) +
+   scale_color_manual(values = colors_strategies[c("动量策略", "沪深300ETF")]) +
+   theme_minimal() +
+   theme(
+     legend.position = c(0.02, 0.98), # 图例在左上角
+     legend.justification = c(0, 1), # 对齐到左上角
+     legend.direction = "vertical", # 图例上下排列
+     legend.title = element_blank(),
+     legend.background = element_rect(fill = "white", color = "gray", size = 0.3),
+     legend.box.margin = margin(5, 5, 5, 5), # 图例内边距
+     legend.spacing.y = unit(0.2, "cm"), # 图例项之间的垂直间距
+     legend.text = element_text(size = 10),
+     plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
+     axis.title.x = element_blank(),
+     axis.text.x = element_blank(),
+     axis.ticks.x = element_blank()
+   )
Warning messages:
1: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.
This warning is displayed once per session.
Call lifecycle::last_lifecycle_warnings() to see where this warning was generated. 
2: The `size` argument of `element_rect()` is deprecated as of ggplot2 3.4.0.
ℹ Please use the `linewidth` argument instead.
This warning is displayed once per session.
Call lifecycle::last_lifecycle_warnings() to see where this warning was generated. 
> 
> # 最大回撤面积图（隐藏标题和X轴，删除图例）
> p1_drawdown <- ggplot(
+   vs_benchmark_drawdown,
+   aes(x = Date, y = 回撤, fill = 策略)
+ ) +
+   geom_area(position = "identity", alpha = area_alpha) + # 使用面积图
+   labs(
+     title = "",
+     x = "日期", y = "回撤"
+   ) +
+   scale_y_continuous(labels = percent_format()) +
+   scale_fill_manual(values = colors_strategies[c("动量策略", "沪深300ETF")]) +
+   theme_minimal() +
+   theme(
+     legend.position = "none", # 删除图例
+     plot.title = element_blank(),
+     axis.title.x = element_text(size = 12)
+   )
> 
> # 使用cowplot组合图表
> p1_combined <- plot_grid(p1_cumulative, p1_drawdown,
+                          ncol = 1, align = "v",
+                          rel_heights = c(1, 0.9)
+ )
> 
> # ============================================================
> # 图表2: 动量策略 vs 等权重组合 组合图
> # ============================================================
> # 筛选数据
> vs_equal_cumulative <- cumulative_df %>%
+   select(Date, 动量策略, 等权重组合) %>%
+   pivot_longer(cols = -Date, names_to = "策略", values_to = "累计收益率")
> 
> vs_equal_drawdown <- drawdown_df %>%
+   select(Date, 动量策略, 等权重组合) %>%
+   pivot_longer(cols = -Date, names_to = "策略", values_to = "回撤")
> 
> # 累计收益率图（隐藏X轴，图例放在左上角，上下排列）
> p2_cumulative <- ggplot(
+   vs_equal_cumulative,
+   aes(x = Date, y = 累计收益率, color = 策略)
+ ) +
+   geom_line(size = 1.2) +
+   labs(
+     title = "动量策略 vs 等权重组合: 累计收益率",
+     x = "", y = "累计收益率"
+   ) +
+   scale_y_continuous(labels = percent_format()) +
+   scale_color_manual(values = colors_strategies[c("动量策略", "等权重组合")]) +
+   theme_minimal() +
+   theme(
+     legend.position = c(0.02, 0.98), # 图例在左上角
+     legend.justification = c(0, 1), # 对齐到左上角
+     legend.direction = "vertical", # 图例上下排列
+     legend.title = element_blank(),
+     legend.background = element_rect(fill = "white", color = "gray", size = 0.3),
+     legend.box.margin = margin(5, 5, 5, 5), # 图例内边距
+     legend.spacing.y = unit(0.2, "cm"), # 图例项之间的垂直间距
+     legend.text = element_text(size = 10),
+     plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
+     axis.title.x = element_blank(),
+     axis.text.x = element_blank(),
+     axis.ticks.x = element_blank()
+   )
> 
> # 最大回撤面积图（隐藏标题和X轴，删除图例）
> p2_drawdown <- ggplot(
+   vs_equal_drawdown,
+   aes(x = Date, y = 回撤, fill = 策略)
+ ) +
+   geom_area(position = "identity", alpha = area_alpha) + # 使用面积图
+   labs(
+     title = "",
+     x = "日期", y = "回撤"
+   ) +
+   scale_y_continuous(labels = percent_format()) +
+   scale_fill_manual(values = colors_strategies[c("动量策略", "等权重组合")]) +
+   theme_minimal() +
+   theme(
+     legend.position = "none", # 删除图例
+     plot.title = element_blank(),
+     axis.title.x = element_text(size = 12)
+   )
> 
> # 使用cowplot组合图表
> p2_combined <- plot_grid(p2_cumulative, p2_drawdown,
+                          ncol = 1, align = "v",
+                          rel_heights = c(1, 0.9)
+ )
> 
> # ============================================================
> # 图表3: 动量策略 vs 三个单独的ETF (Buy&Hold) 组合图
> # ============================================================
> # 计算各ETF的累计收益率
> etf_cumulative <- do.call(
+   merge,
+   lapply(
+     1:length(etf_names),
+     function(i) cumprod(1 + na.fill(returns_all[, i], 0)) - 1
+   )
+ )
> colnames(etf_cumulative) <- etf_names
> 
> # 计算各ETF的回撤
> etf_drawdowns <- do.call(
+   merge,
+   lapply(
+     1:length(etf_names),
+     function(i) calculate_drawdown(returns_all[, i])
+   )
+ )
> colnames(etf_drawdowns) <- etf_names
> 
> # 合并策略和各ETF的数据
> all_cumulative <- merge(cumulative_returns[, "动量策略"], etf_cumulative)
> all_drawdowns <- merge(calculate_drawdown(strategy_returns), etf_drawdowns)
> 
> # 转换为数据框用于ggplot
> all_cumulative_df <- data.frame(
+   Date = index(all_cumulative),
+   as.data.frame(all_cumulative)
+ )
> all_drawdowns_df <- data.frame(
+   Date = index(all_drawdowns),
+   as.data.frame(all_drawdowns)
+ )
> 
> # 转换为长格式
> all_cumulative_long <- pivot_longer(all_cumulative_df,
+                                     cols = -Date,
+                                     names_to = "策略",
+                                     values_to = "累计收益率"
+ )
> 
> all_drawdowns_long <- pivot_longer(all_drawdowns_df,
+                                    cols = -Date,
+                                    names_to = "策略",
+                                    values_to = "回撤"
+ )
> 
> # 设置颜色方案 - 动量策略和三个ETF（确保每个都有不同颜色）
> colors_buyhold <- c(
+   "动量策略" = "#E41A1C", # 红色
+   "纳指ETF" = "#377EB8", # 蓝色
+   "沪深300ETF" = "#4DAF4A", # 绿色
+   "黄金ETF" = "#984EA3" # 紫色
+ )
> 
> # 确保策略名称与颜色方案匹配
> all_cumulative_long$策略 <- factor(all_cumulative_long$策略,
+                                  levels = names(colors_buyhold)
+ )
> all_drawdowns_long$策略 <- factor(all_drawdowns_long$策略,
+                                 levels = names(colors_buyhold)
+ )
> 
> # 累计收益率图（隐藏X轴，图例放在左上角，上下排列）
> p3_cumulative <- ggplot(
+   all_cumulative_long,
+   aes(x = Date, y = 累计收益率, color = 策略)
+ ) +
+   geom_line(size = 1.0) +
+   labs(
+     title = "动量策略 vs 各ETF买入持有策略: 累计收益率",
+     x = "", y = "累计收益率"
+   ) +
+   scale_y_continuous(labels = percent_format()) +
+   scale_color_manual(values = colors_buyhold) + # 确保应用颜色方案
+   theme_minimal() +
+   theme(
+     legend.position = c(0.02, 0.98), # 图例在左上角
+     legend.justification = c(0, 1), # 对齐到左上角
+     legend.direction = "vertical", # 图例上下排列
+     legend.title = element_blank(),
+     legend.background = element_rect(fill = "white", color = "gray", size = 0.3),
+     legend.box.margin = margin(5, 5, 5, 5), # 图例内边距
+     legend.spacing.y = unit(0.15, "cm"), # 图例项之间的垂直间距
+     legend.text = element_text(size = 9),
+     plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
+     axis.title.x = element_blank(),
+     axis.text.x = element_blank(),
+     axis.ticks.x = element_blank()
+   )
> 
> # 最大回撤面积图（隐藏标题和X轴，删除图例）
> p3_drawdown <- ggplot(
+   all_drawdowns_long,
+   aes(x = Date, y = 回撤, fill = 策略)
+ ) +
+   geom_area(position = "identity", alpha = area_alpha) + # 使用面积图
+   labs(
+     title = "",
+     x = "日期", y = "回撤"
+   ) +
+   scale_y_continuous(labels = percent_format()) +
+   scale_fill_manual(values = colors_buyhold) + # 确保应用颜色方案
+   theme_minimal() +
+   theme(
+     legend.position = "none", # 删除图例
+     plot.title = element_blank(),
+     axis.title.x = element_text(size = 12)
+   )
> 
> # 使用cowplot组合图表
> p3_combined <- plot_grid(p3_cumulative, p3_drawdown,
+                          ncol = 1, align = "v",
+                          rel_heights = c(1, 0.9)
+ )
> 
> # ============================================================
> # 图表4: 权重随时间变化图
> # ============================================================
> # 准备权重数据
> weights_long <- pivot_longer(daily_weights_df,
+                              cols = all_of(etf_names),
+                              names_to = "ETF",
+                              values_to = "Weight"
+ )
> 
> # 权重图颜色方案
> colors_weights <- c(
+   "纳指ETF" = "#E41A1C", # 红色
+   "沪深300ETF" = "#377EB8", # 蓝色
+   "黄金ETF" = "#4DAF4A" # 绿色
+ )
> 
> p4 <- ggplot(weights_long, aes(x = Date, y = Weight, fill = ETF)) +
+   geom_area(position = "stack", alpha = 0.7) +
+   labs(
+     title = "动量策略: 每日权重分配",
+     x = "日期", y = "权重"
+   ) +
+   scale_y_continuous(labels = percent_format()) +
+   scale_fill_manual(values = colors_weights) +
+   theme_minimal() +
+   theme(
+     legend.position = "bottom",
+     plot.title = element_text(hjust = 0.5, size = 14, face = "bold")
+   )
> 
> # 12. 显示图表
> cat("\n正在显示图表...\n")

正在显示图表...
> print(p1_combined)
> cat("\n\n")


> print(p2_combined)
> cat("\n\n")


> print(p3_combined)
> cat("\n\n")


> print(p4)
> 
> # 13. 保存结果到文件
> output_dir <- "momentum_strategy_backtest"
> if (!dir.exists(output_dir)) {
+   dir.create(output_dir)
+ }
> 
> # 保存绩效指标数据框
> write.csv(performance_metrics_df,
+           file = paste0(output_dir, "/performance_metrics.csv"),
+           row.names = FALSE, fileEncoding = "UTF-8"
+ )
> 
> # 保存权重数据
> write.csv(daily_weights_df,
+           file = paste0(output_dir, "/daily_weights.csv"),
+           row.names = FALSE, fileEncoding = "UTF-8"
+ )
> 
> # 保存每个ETF的权重数据
> for (etf in etf_names) {
+   write.csv(etf_weight_dfs[[etf]],
+             file = paste0(output_dir, "/", etf, "_weights.csv"),
+             row.names = FALSE, fileEncoding = "UTF-8"
+   )
+ }
> 
> # 保存合并的ETF权重数据
> write.csv(all_etf_weights_df,
+           file = paste0(output_dir, "/all_etf_weights.csv"),
+           row.names = FALSE, fileEncoding = "UTF-8"
+ )
> 
> # 保存累计收益率数据
> write.csv(cumulative_df,
+           file = paste0(output_dir, "/cumulative_returns.csv"),
+           row.names = FALSE, fileEncoding = "UTF-8"
+ )
> 
> # 保存回撤数据
> write.csv(drawdown_df,
+           file = paste0(output_dir, "/drawdowns.csv"),
+           row.names = FALSE, fileEncoding = "UTF-8"
+ )
> 
> # 保存Buy&Hold数据
> write.csv(all_cumulative_df,
+           file = paste0(output_dir, "/buyhold_cumulative.csv"),
+           row.names = FALSE, fileEncoding = "UTF-8"
+ )
> 
> write.csv(all_drawdowns_df,
+           file = paste0(output_dir, "/buyhold_drawdowns.csv"),
+           row.names = FALSE, fileEncoding = "UTF-8"
+ )
> 
> # 保存图表
> ggsave(paste0(output_dir, "/momentum_vs_benchmark.png"), p1_combined, width = 10, height = 8)
> ggsave(paste0(output_dir, "/momentum_vs_equal_weight.png"), p2_combined, width = 10, height = 8)
> ggsave(paste0(output_dir, "/momentum_vs_etfs_buyhold.png"), p3_combined, width = 10, height = 8)
> ggsave(paste0(output_dir, "/daily_weights_plot.png"), p4, width = 10, height = 6)
> 
> cat("\n==================== 回测完成 ====================\n")

==================== 回测完成 ====================
> cat("结果已保存到文件夹:", output_dir, "\n")
结果已保存到文件夹: momentum_strategy_backtest 
> cat("包含文件:\n")
包含文件:
> cat("1. performance_metrics.csv - 绩效指标汇总数据框\n")
1. performance_metrics.csv - 绩效指标汇总数据框
> cat("2. daily_weights.csv - 每日权重分配数据框\n")
2. daily_weights.csv - 每日权重分配数据框
> cat("3. [ETF名称]_weights.csv - 每个ETF的权重数据框\n")
3. [ETF名称]_weights.csv - 每个ETF的权重数据框
> cat("4. all_etf_weights.csv - 所有ETF合并的权重数据框\n")
4. all_etf_weights.csv - 所有ETF合并的权重数据框
> cat("5. cumulative_returns.csv - 累计收益率数据\n")
5. cumulative_returns.csv - 累计收益率数据
> cat("6. drawdowns.csv - 回撤数据\n")
6. drawdowns.csv - 回撤数据
> cat("7. buyhold_cumulative.csv - Buy&Hold累计收益率数据\n")
7. buyhold_cumulative.csv - Buy&Hold累计收益率数据
> cat("8. buyhold_drawdowns.csv - Buy&Hold回撤数据\n")
8. buyhold_drawdowns.csv - Buy&Hold回撤数据
> cat("9. momentum_vs_benchmark.png - 动量策略vs沪深300ETF组合图\n")
9. momentum_vs_benchmark.png - 动量策略vs沪深300ETF组合图
> cat("10. momentum_vs_equal_weight.png - 动量策略vs等权重组合对比图\n")
10. momentum_vs_equal_weight.png - 动量策略vs等权重组合对比图
> cat("11. momentum_vs_etfs_buyhold.png - 动量策略vs各ETF买入持有策略组合图\n")
11. momentum_vs_etfs_buyhold.png - 动量策略vs各ETF买入持有策略组合图
> cat("12. daily_weights_plot.png - 每日权重分配图\n")
12. daily_weights_plot.png - 每日权重分配图













> source("~/RStudio-Quant/etf-momentum.R")
正在加载ETF数据...
从缓存文件加载: 513100.SS 
  缓存数据日期范围不足，重新下载
从Yahoo Finance下载: 513100.SS 
  数据已保存到缓存文件: origin_data/513100_SS.rds 
从缓存文件加载: 510300.SS 
  缓存数据日期范围不足，重新下载
从Yahoo Finance下载: 510300.SS 
  数据已保存到缓存文件: origin_data/510300_SS.rds 
从缓存文件加载: 518880.SS 
  缓存数据日期范围不足，重新下载
从Yahoo Finance下载: 518880.SS 
  数据已保存到缓存文件: origin_data/518880_SS.rds 
所有ETF数据加载完成

正在计算动量指标...
正在计算每日权重...
正在计算绩效指标...
==================== 绩效指标汇总数据框 ====================

        策略 年化收益率 年化波动率 夏普比率 最大回撤 卡尔马比率 索提诺比率  胜率 正收益天数 总交易天数                 回测期间
1   动量策略      50.09      17.01    2.946     8.72      5.747      0.251 53.29        267        501 2024-01-01 至 2026-01-27
2 沪深300ETF      21.11      18.93    1.115    16.25      1.299      0.109 51.60        258        500 2024-01-01 至 2026-01-27
3 等权重组合      33.97      12.78    2.658     9.29      3.658      0.216 59.48        298        501 2024-01-01 至 2026-01-27

==================== 每日组合权重数据框 ====================

每日组合权重数据框（前10行）:
         Date 纳指ETF 沪深300ETF 黄金ETF 权重合计
1  2024-01-02       0          0       0        0
2  2024-01-03       0          0       0        0
3  2024-01-04       0          0       0        0
4  2024-01-05       0          0       0        0
5  2024-01-08       0          0       0        0
6  2024-01-09       0          0       0        0
7  2024-01-10       0          0       0        0
8  2024-01-11       0          0       0        0
9  2024-01-12       0          0       0        0
10 2024-01-15       0          0       0        0

每日组合权重数据框（后10行）:
          Date    纳指ETF 沪深300ETF   黄金ETF 权重合计
492 2026-01-13 0.00000000  0.4951292 0.5048708        1
493 2026-01-14 0.04341420  0.4717608 0.4848250        1
494 2026-01-15 0.11744744  0.4751051 0.4074475        1
495 2026-01-16 0.03744561  0.4600617 0.5024926        1
496 2026-01-19 0.05013198  0.4621911 0.4876769        1
497 2026-01-20 0.00000000  0.4098014 0.5901986        1
498 2026-01-21 0.00000000  0.3491649 0.6508351        1
499 2026-01-22 0.00000000  0.3705332 0.6294668        1
500 2026-01-23 0.00000000  0.2265571 0.7734429        1
501 2026-01-26 0.00000000  0.1810968 0.8189032        1

组合权重统计信息:
总交易日数: 501 
有权重分配的交易日数: 470 
无权重分配的交易日数: 31 

各ETF权重统计:
纳指ETF :
  平均权重: 30.04 %
  最大权重: 100 %
  最小权重: 0 %
  正权重天数: 336 
  零权重天数: 165 

沪深300ETF :
  平均权重: 22.89 %
  最大权重: 100 %
  最小权重: 0 %
  正权重天数: 292 
  零权重天数: 209 

黄金ETF :
  平均权重: 40.88 %
  最大权重: 100 %
  最小权重: 0 %
  正权重天数: 369 
  零权重天数: 132 

==================== 每个ETF的权重数据框 ====================

纳指ETF 权重数据框（前5行）:
        Date     ETF Weight
1 2024-01-02 纳指ETF      0
2 2024-01-03 纳指ETF      0
3 2024-01-04 纳指ETF      0
4 2024-01-05 纳指ETF      0
5 2024-01-08 纳指ETF      0

沪深300ETF 权重数据框（前5行）:
        Date        ETF Weight
1 2024-01-02 沪深300ETF      0
2 2024-01-03 沪深300ETF      0
3 2024-01-04 沪深300ETF      0
4 2024-01-05 沪深300ETF      0
5 2024-01-08 沪深300ETF      0

黄金ETF 权重数据框（前5行）:
        Date     ETF Weight
1 2024-01-02 黄金ETF      0
2 2024-01-03 黄金ETF      0
3 2024-01-04 黄金ETF      0
4 2024-01-05 黄金ETF      0
5 2024-01-08 黄金ETF      0

正在生成图表...

正在显示图表...

==================== 回测完成 ====================
结果已保存到文件夹: momentum_strategy_backtest 
包含文件:
1. performance_metrics.csv - 绩效指标汇总数据框
2. daily_weights.csv - 每日权重分配数据框
3. [ETF名称]_weights.csv - 每个ETF的权重数据框
4. all_etf_weights.csv - 所有ETF合并的权重数据框
5. cumulative_returns.csv - 累计收益率数据
6. drawdowns.csv - 回撤数据
7. buyhold_cumulative.csv - Buy&Hold累计收益率数据
8. buyhold_drawdowns.csv - Buy&Hold回撤数据
9. momentum_vs_benchmark.png - 动量策略vs沪深300ETF组合图
10. momentum_vs_equal_weight.png - 动量策略vs等权重组合对比图
11. momentum_vs_etfs_buyhold.png - 动量策略vs各ETF买入持有策略组合图
12. daily_weights_plot.png - 每日权重分配图